#!/usr/bin/env python3
import os
import sys

VALID_FS = [
    "ext4", "ext3", "ext2", "xfs", "btrfs", "zfs", "vfat",
    "nfs", "nfs4", "cifs", "tmpfs", "overlay"
]

def humanize(size):
    for unit in "BKMGTP":
        if size < 1024:
            return f"{size:.1f}{unit}"
        size /= 1024
    return f"{size:.1f}P"

def get_stats(path):
    s = os.statvfs(path)
    return s.f_blocks * s.f_frsize, s.f_bfree * s.f_frsize

def main():
    args = sys.argv[1:]
    human = "-h" in args
    if human:
        args = [a for a in args if a != "-h"]

    print(f"{'Filesystem':<20} {'Total':>12} {'Free':>12} {'Mounted on'}")

    if not args:
        with open("/proc/self/mounts") as f:
            for line in f:
                parts = line.split()
                if len(parts) < 4:
                    continue
                dev, mountpoint, fstype = parts[0], parts[1], parts[2]
                if fstype not in VALID_FS:
                    continue
                try:
                    total, free = get_stats(mountpoint)
                except:
                    continue
                t = humanize(total) if human else f"{total:>12}"
                f = humanize(free)  if human else f"{free:>12}"
                print(f"{dev:<20} {t:>12} {f:>12} {mountpoint}")
    else:
        seen = set()
        for path in args:
            if not os.path.exists(path):
                continue
            p = os.path.abspath(path)
            while p not in seen and not os.path.ismount(p):
                p = os.path.dirname(p)
            if p in seen:
                continue
            seen.add(p)

            dev = "unknown"
            with open("/proc/self/mounts") as f:
                for line in f:
                    if len(line.split()) >= 2 and line.split()[1] == p:
                        dev = line.split()[0]
                        break

            try:
                total, free = get_stats(p)
            except:
                continue

            t = humanize(total) if human else f"{total:>12}"
            f = humanize(free)  if human else f"{free:>12}"
            print(f"{dev:<20} {t:>12} {f:>12} {p}")

if __name__ == "__main__":
    main()
