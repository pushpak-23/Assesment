#!/usr/bin/env python3
import os
import sys
import time
import pwd

def format_mode(mode):
    s = []

    # File type
    t = mode & 0o170000
    s.append({0o040000: 'd', 0o120000: 'l', 0o100000: '-', 
               0o010000: 'p', 0o020000: 'c', 0o060000: 'b', 0o140000: 's'}.get(t, '?'))

    # Owner rwx
    s.append('r' if mode & 0o400 else '-')
    s.append('w' if mode & 0o200 else '-')
    s.append('x' if mode & 0o100 else '-')
    # Group rwx
    s.append('r' if mode & 0o040 else '-')
    s.append('w' if mode & 0o020 else '-')
    s.append('x' if mode & 0o010 else '-')
    # Others rwx
    s.append('r' if mode & 0o004 else '-')
    s.append('w' if mode & 0o002 else '-')
    s.append('x' if mode & 0o001 else '-')

    return ''.join(s)

def format_time(mtime):
    now = time.time()
    if now - mtime < 180 * 24 * 3600:
        return time.strftime("%b %d %H:%M", time.localtime(mtime))
    else:
        return time.strftime("%b %d  %Y", time.localtime(mtime))

def get_owner(uid):
    try:
        return pwd.getpwuid(uid).pw_name
    except KeyError:
        return str(uid)

def list_path(path, recursive=False):
    if not os.path.isdir(path):
        # It's a file
        try:
            st = os.lstat(path)
        except FileNotFoundError:
            print(f"mini-ls: cannot access '{path}': No such file or directory", file=sys.stderr)
            return
        name = os.path.basename(path)
        print(f"{format_mode(st.st_mode)}  {get_owner(st.st_uid):8} {format_time(st.st_mtime)} {name}")
        return

    # It's a directory
    try:
        names = os.listdir(path)
    except PermissionError:
        print(f"mini-ls: cannot open directory '{path}': Permission denied", file=sys.stderr)
        return

    entries = []
    for name in names:
        fp = os.path.join(path, name)
        try:
            st = os.lstat(fp)
            entries.append((fp, name, st))
        except:
            continue

    # Sort: dirs first, then by name
    entries.sort(key=lambda x: (not (x[2].st_mode & 0o040000 == 0o040000), x[1].lower()))

    for fp, name, st in entries:
        print(f"{format_mode(st.st_mode)}  {get_owner(st.st_uid):8} {format_time(st.st_mtime)} {name}")
        if recursive and (st.st_mode & 0o170000) == 0o040000 and not os.path.islink(fp):
            print(f"\n{fp}:")
            list_path(fp, recursive=True)

def main():
    args = sys.argv[1:]
    recursive = "-r" in args
    if recursive:
        args = [a for a in args if a != "-r"]

    paths = args or ["."]

    for i, path in enumerate(paths):
        if i > 0:
            print()
        if len(paths) > 1 or recursive:
            print(f"{path}:")
        list_path(path, recursive)

if __name__ == "__main__":
    main()
